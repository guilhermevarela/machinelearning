import numpy as np
import matplotlib.pyplot as plt 
from optimistic_initial_values import run_experiment as run_experiment_iov
from ucb1 import run_experiment as run_experiment_ucb
class Bandit:
	def __init__(self, m):
		self.m = m
		self.mean = 0 
		self.N = 1

	def pull(self):
		return np.random.randn() + self.m

	def update(self, x):
		self.N +=  1
		self.mean = (1 - 1.0 / self.N) * self.mean + 1.0 / self.N * x
class BaysianBandit:
	def __init__(self, m):
		self.m = m
		# parameters for mu - prior is N(0,1)
		self.m0 = 0  
		self.lambda0 = 1
		self.sum_x = 0 # for convenience
		self.tau = 1

	def pull(self):
		return np.random.randn() + self.m

	def sample(self):
		return np.random.randn() / np.sqrt(self.lambda0) + self.m0

	def update(self, x):
		self.lambda0 += 1
		self.sum_x += x
		self.m0 = self.tau * self.sum_x / self.lambda0
		  
def run_experiment(m1, m2, m3, N):
	bandits = [BaysianBandit(m1), BaysianBandit(m2), BaysianBandit(m3)] 

	data = np.empty( N )
	for i in range(N):
		j = np.argmax([b.sample() for b in bandits])   
		x = bandits[j].pull()
		bandits[j].update(x) 
		
		# for the plot
		data[i] = x
		n[j] += 1
 
	cumulative_average = np.cumsum(data) / (np.arange(N) + 1)

	#plot moving average ctr
	plt.plot(cumulative_average)
	plt.plot(np.ones(N) * m1 )
	plt.plot(np.ones(N) * m2 )
	plt.plot(np.ones(N) * m3 )
	plt.xscale('log')
	plt.show() 
	
	for b in bandits:
		print(b.mean)
	return cumulative_average

def run_experiment_decaying_epsilon(m1, m2, m3, N):
	bandits = [Bandit(m1), Bandit(m2), Bandit(m3)] 

	data = np.empty( N )
	for i in range(N):
		p = np.random.randn()
		if p < 1 / ( i + 1 ):
			# explore
			j = np.random.randint(3)  
		else: 
			# exploit
			j = np.argmax([b.mean for b in bandits])   
		x = bandits[j].pull()
		bandits[j].update(x) 
		
		# for the plot
		data[i] = x
 
	cumulative_average = np.cumsum(data) / (np.arange(N) + 1)

	#plot moving average ctr
	plt.plot(cumulative_average)
	plt.plot(np.ones(N) * m1 )
	plt.plot(np.ones(N) * m2 )
	plt.plot(np.ones(N) * m3 )
	plt.xscale('log')
	plt.show() 
	
	for b in bandits:
		print(b.mean)
if __name__ == '__main__':
	eps_decay = run_experiment_decaying_epsilon(1.0, 2.0, 3.0, 10000) 
	 	      
	iov = run_experiment_iov(1.0, 2.0, 3.0, 10000) 

	ucb = run_experiment_ucb(1.0, 2.0, 3.0, 10000) 
	
	bayes = run_experiment(1.0, 2.0, 3.0, 10000) 

	plt.plot(c_1, label='eps-decaying') 
	plt.plot(iov, label='optimistic') 
	plt.plot(ucb, label='ucb') 
	plt.plot(bayes, label='bayes') 
	plt.legend()
	plt.xscale('log')
	plt.show()
